{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="bg-white p-8 rounded-lg shadow-md">
    <!-- Pitch Header -->
    <!-- <div class="border-b border-gray-200 pb-6 mb-6">
        <h1 class="text-4xl font-extrabold text-gray-900">{{ pitch.title }}</h1>
        <div class="mt-3 flex items-center justify-between">
            <div>
                <p class="text-lg text-gray-600">From: <span class="font-semibold">{{ pitch.entrepreneur.first_name }} {{ pitch.entrepreneur.last_name }}</span></p>
                <p class="text-md text-gray-500">Company: {{ pitch.entrepreneur.entrepreneur_profile.company_name }}</p>
            </div>
            <div class="text-right">
                <p class="text-2xl font-bold text-green-600">₹{{ pitch.funding_amount|floatformat:2 }}</p>
                <p class="text-sm text-gray-500">Funding Requested</p>
            </div>
        </div>
    </div> -->

    <!-- Pitch Header -->
    <div class="flex flex-col md:flex-row items-start gap-8 border-b border-gray-200 pb-6 mb-6">
        <!-- Logo Column -->
        <div class="w-full md:w-1/4 flex-shrink-0">
            {% if pitch.entrepreneur.entrepreneur_profile.company_logo %}
                <img src="{{ pitch.entrepreneur.entrepreneur_profile.company_logo.url }}" alt="{{ pitch.entrepreneur.entrepreneur_profile.company_name }} Logo" class="rounded-lg shadow-md w-full">
            {% else %}
                <img src="https://placehold.co/400x400/34495E/FFFFFF?text={{ pitch.entrepreneur.entrepreneur_profile.company_name|urlencode }}" alt="{{ pitch.entrepreneur.entrepreneur_profile.company_name }} Logo" class="rounded-lg shadow-md w-full">
            {% endif %}
        </div>

        <!-- Details Column -->
        <div class="w-full md:w-3/4">
            <h1 class="text-4xl font-extrabold text-gray-900">{{ pitch.title }}</h1>
            <div class="mt-3">
                <p class="text-lg text-gray-600">From: <span class="font-semibold">{{ pitch.entrepreneur.first_name }} {{ pitch.entrepreneur.last_name }}</span></p>
                <p class="text-md text-gray-500">Company: {{ pitch.entrepreneur.entrepreneur_profile.company_name }}</p>
                <p class="text-md text-gray-500">Industry: {{ pitch.entrepreneur.entrepreneur_profile.industry }}</p>
            </div>
            <div class="mt-4">
                <p class="text-2xl font-bold text-green-600">₹{{ pitch.funding_amount|floatformat:2 }}</p>
                <p class="text-sm text-gray-500">Funding Requested</p>
            </div>
        </div>
    </div>

    <!-- Pitch Body -->
    <div>
        <h2 class="text-2xl font-semibold text-gray-800 mb-3">Pitch Summary</h2>
        <p class="text-gray-700 leading-relaxed mb-6">{{ pitch.summary }}</p>

        <h2 class="text-2xl font-semibold text-gray-800 mb-3">Full Details</h2>
        <div class="prose max-w-none text-gray-800">
            {{ pitch.details|linebreaks }}
        </div>
    </div>

    <!-- About the Company Section -->
    <div class="mt-8 pt-6 border-t border-gray-200">
        <h2 class="text-2xl font-semibold text-gray-800 mb-3">About the Company</h2>
        <div class="prose max-w-none text-gray-800">
            {{ pitch.entrepreneur.entrepreneur_profile.company_details|linebreaks }}
        </div>
    </div>

    <!-- Make an Offer Section -->
    <div class="mt-8 border-t border-gray-200 pt-6">
        <h2 class="text-2xl font-semibold text-center text-gray-800 mb-4">Make an Investment Offer</h2>
        
        {% if existing_offer %}
            <div class="text-center bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md" role="alert">
                <p class="font-bold">You have already made an offer on this pitch.</p>
                <p>Status: <span class="font-semibold">{{ existing_offer.get_status_display }}</span></p>
            </div>
        {% else %}
            <!-- NEW: This block will display any form errors -->
            {% if offer_form.errors %}
                <div class="form-error-container max-w-lg mx-auto">
                    <ul class="form-error-list">
                    {% for field in offer_form %}
                        {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in offer_form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <form method="post" class="max-w-lg mx-auto">
                {% csrf_token %}
                <div class="space-y-4">
                    {{ offer_form.as_p }}
                </div>
                <div class="text-center mt-6">
                    <button type="submit" class="btn btn-green">Submit Offer</button>
                </div>
            </form>
        {% endif %}
    </div>

    <!-- Offer List Section -->
    <div class="mt-8 pt-6 border-t border-gray-200">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Offers on this Pitch</h2>
        <div class="space-y-4">
            {% for offer in offers %}
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-lg">Offer: <span class="text-blue-600">₹{{ offer.amount|floatformat:2 }}</span></p>
                            <p class="text-sm text-gray-600">From: {{ offer.investor.first_name }} {{ offer.investor.last_name }}</p>
                        </div>
                        <div>
                            {% if offer.status == 'accepted' %}
                                <span class="tag tag-green">Accepted</span>
                            {% elif offer.status == 'rejected' %}
                                <span class="tag tag-red">Rejected</span>
                            {% else %}
                                <span class="tag tag-yellow">Pending</span>
                            {% endif %}
                        </div>
                    </div>
                    <p class="mt-2 text-gray-700 italic">"{{ offer.message }}"</p>
                </div>
            {% empty %}
                <p class="text-gray-500">No offers have been made on this pitch yet.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Q&A Section -->
    <div class="bg-white p-8 rounded-lg shadow-md card">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Public Q&A</h2>

        <!-- Form for investors to ask a question -->
        {% if user.is_authenticated and user.user_type == 2 %}
            <div class="mb-8 border-b border-gray-200 pb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Ask a Question</h3>
                <form method="post">
                    {% csrf_token %}
                    {{ question_form.as_p }}
                    <div class="text-left mt-4">
                        <button type="submit" name="submit_question" class="btn btn-primary">Submit Question</button>
                    </div>
                </form>
            </div>
        {% endif %}

        <!-- List of existing questions and answers -->
        <div class="space-y-6">
            {% for q in questions %}
                <div class="p-4 border border-gray-200 rounded-lg">
                    <p class="font-semibold text-gray-800">Q: {{ q.text }}</p>
                    <p class="text-sm text-gray-500 mt-1">Asked by {{ q.author.first_name }} {{ q.author.last_name }} on {{ q.created_at|date:"F d, Y" }}</p>
                    
                    {% if q.answer %}
                        <div class="mt-3 pt-3 border-t border-gray-100 pl-4">
                            <p class="font-semibold text-green-700">A: {{ q.answer.text }}</p>
                            <p class="text-sm text-gray-500 mt-1">Answered by {{ q.answer.author.first_name }} {{ q.answer.author.last_name }} on {{ q.answer.created_at|date:"F d, Y" }}</p>
                        </div>
                    {% else %}
                        <p class="mt-2 text-sm text-gray-400 italic">No answer yet.</p>
                    {% endif %}
                </div>
            {% empty %}
                <p class="text-gray-500">No questions have been asked yet.</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

